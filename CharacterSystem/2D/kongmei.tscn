[gd_scene load_steps=5 format=3 uid="uid://b0tptcgwjhjvg"]

[ext_resource type="Shader" uid="uid://dm1m86ca5lppf" path="res://assets/Shaders/Character2D.gdshader" id="2_stxkd"]
[ext_resource type="Texture2D" uid="uid://b5emm4mi2bseq" path="res://assets/Pictures/characters/空美/kitchen/smile.png" id="3_d525r"]

[sub_resource type="GDScript" id="GDScript_wdx01"]
script/source = "extends Node2D
@onready var sprite := $Sprite2D as Sprite2D
# 缓存已加载的纹理，避免重复 load
var cache := {}

# 当前显示的表情名（持久化用）
var current_key := \"normal\"

# 切换表情，duration 控制过渡时间
func change_emotion(new_key: String, duration := 0.4):
	if new_key == current_key: return

	var m := sprite.material as ShaderMaterial
	# 首次调用时初始化
	if not m.get_shader_parameter(\"tex_from\"):
		m.set_shader_parameter(\"tex_from\", load_portrait(current_key))

	# 设置两张图
	m.set_shader_parameter(\"tex_to\",   load_portrait(new_key))
	m.set_shader_parameter(\"tex_from\", load_portrait(current_key))
	m.set_shader_parameter(\"progress\", 0.0)

	current_key = new_key

	# 手动推进 progress（无 Tween，每帧自增）
	var t := 0.0
	while t < duration:
		t += get_process_delta_time()
		m.set_shader_parameter(\"progress\", clamp(t / duration, 0.0, 1.0))
		await get_tree().process_frame

	# 结束后把 to 变成新的 from，方便下次
	m.set_shader_parameter(\"tex_from\", load_portrait(current_key))
	m.set_shader_parameter(\"progress\", 0.0)

# 封装加载，带缓存
func load_portrait(key: String) -> Texture2D:
	if not cache.has(key):
		var path = Global.get_character_path(\"空美\",\"kitchen\",current_key)
		cache[key] = load(path % key)
	return cache[key]
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_rmg28"]
shader = ExtResource("2_stxkd")
shader_parameter/progress = 0.0

[node name="kongmei" type="Node2D"]
script = SubResource("GDScript_wdx01")

[node name="Sprite2D" type="Sprite2D" parent="."]
material = SubResource("ShaderMaterial_rmg28")
position = Vector2(0, -424)
texture = ExtResource("3_d525r")
